function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const fs = require('fs');

const path = require('path');

const get = require('lodash.get');

const set = require('lodash.set');

const mergeWith = require('lodash.mergewith');

const yaml = require('js-yaml');

const concatArrays = (objValue, srcValue) => [objValue, srcValue].every(Array.isArray) ? objValue.concat(srcValue) : undefined;

const loadRecursive = (dir, relDir, data, vars) => {
  let result = data;

  if (typeof result === 'string' || result instanceof String) {
    // replace yaml variables with defaults
    result = result.replace(/\${opt:([a-zA-Z0-9]+?)(?:, ["']([a-zA-Z0-9\-.]+?)["'])?}/g, (match, k, v) => get(vars, k, v || match)); // load requires

    const match = /^\${(require|file|fileFn)\(([~^]?[a-zA-Z\d._\-@/]+?)\)(?::([a-zA-Z\d.]+?))?(?:, ([a-zA-Z\d=\-&/.:[\],]+?))?}$/g.exec(result);

    if (match) {
      const varsNew = _objectSpread({}, vars, {}, match[4] ? JSON.parse(`{"${match[4].replace(/&/g, '","').replace(/=/g, '":"')}"}`) : {});

      let loaded;
      let newRelDir = relDir;

      if (['file', 'fileFn'].includes(match[1])) {
        const filePath = match[2].startsWith('^') ? path.join(relDir, match[2].substring(1)) : path.join(dir, match[2]);
        newRelDir = path.dirname(filePath);
        loaded = filePath.endsWith('.yml') || filePath.endsWith('.yaml') ? yaml.safeLoad(fs.readFileSync(filePath, 'utf8')) // eslint-disable-next-line global-require, import/no-dynamic-require
        : require(filePath);

        if (match[1] === 'fileFn') {
          loaded = loaded(varsNew);
        }
      } else {
        // eslint-disable-next-line global-require, import/no-dynamic-require
        loaded = require(match[2]);
      }

      const target = match[3] ? get(loaded, match[3]) : loaded;
      result = loadRecursive(dir, newRelDir, typeof target === 'function' ? target() : target, varsNew);
    }
  }

  if (result instanceof Object) {
    const toMerge = get(result, '<<<', []).map(e => loadRecursive(dir, relDir, e, vars));
    delete result['<<<'];
    Object.keys(result).forEach(key => set(result, key, loadRecursive(dir, relDir, get(result, key), vars)));
    result = toMerge.reduce((prev, cur) => mergeWith(prev, cur, concatArrays), result);
  }

  return result;
};

module.exports.load = (filePath, vars = {}) => loadRecursive(path.dirname(filePath), path.dirname(filePath), yaml.safeLoad(fs.readFileSync(filePath, 'utf8')), vars);

module.exports.dump = yaml.safeDump;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwYXRoIiwiZ2V0Iiwic2V0IiwibWVyZ2VXaXRoIiwieWFtbCIsImNvbmNhdEFycmF5cyIsIm9ialZhbHVlIiwic3JjVmFsdWUiLCJldmVyeSIsIkFycmF5IiwiaXNBcnJheSIsImNvbmNhdCIsInVuZGVmaW5lZCIsImxvYWRSZWN1cnNpdmUiLCJkaXIiLCJyZWxEaXIiLCJkYXRhIiwidmFycyIsInJlc3VsdCIsIlN0cmluZyIsInJlcGxhY2UiLCJtYXRjaCIsImsiLCJ2IiwiZXhlYyIsInZhcnNOZXciLCJKU09OIiwicGFyc2UiLCJsb2FkZWQiLCJuZXdSZWxEaXIiLCJpbmNsdWRlcyIsImZpbGVQYXRoIiwic3RhcnRzV2l0aCIsImpvaW4iLCJzdWJzdHJpbmciLCJkaXJuYW1lIiwiZW5kc1dpdGgiLCJzYWZlTG9hZCIsInJlYWRGaWxlU3luYyIsInRhcmdldCIsIk9iamVjdCIsInRvTWVyZ2UiLCJtYXAiLCJlIiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJyZWR1Y2UiLCJwcmV2IiwiY3VyIiwibW9kdWxlIiwiZXhwb3J0cyIsImxvYWQiLCJkdW1wIiwic2FmZUR1bXAiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLE1BQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUQsQ0FBbEI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNRSxHQUFHLEdBQUdGLE9BQU8sQ0FBQyxZQUFELENBQW5COztBQUNBLE1BQU1HLEdBQUcsR0FBR0gsT0FBTyxDQUFDLFlBQUQsQ0FBbkI7O0FBQ0EsTUFBTUksU0FBUyxHQUFHSixPQUFPLENBQUMsa0JBQUQsQ0FBekI7O0FBQ0EsTUFBTUssSUFBSSxHQUFHTCxPQUFPLENBQUMsU0FBRCxDQUFwQjs7QUFFQSxNQUFNTSxZQUFZLEdBQUcsQ0FBQ0MsUUFBRCxFQUFXQyxRQUFYLEtBQXlCLENBQUNELFFB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Q0FBQ0MsT0FBUCxDQUFlRSxJQUFmLEdBQXNCakQsSUFBSSxDQUFDa0QsUUFBM0IiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgZ2V0ID0gcmVxdWlyZSgnbG9kYXNoLmdldCcpO1xuY29uc3Qgc2V0ID0gcmVxdWlyZSgnbG9kYXNoLnNldCcpO1xuY29uc3QgbWVyZ2VXaXRoID0gcmVxdWlyZSgnbG9kYXNoLm1lcmdld2l0aCcpO1xuY29uc3QgeWFtbCA9IHJlcXVpcmUoJ2pzLXlhbWwnKTtcblxuY29uc3QgY29uY2F0QXJyYXlzID0gKG9ialZhbHVlLCBzcmNWYWx1ZSkgPT4gKFtvYmpWYWx1ZSwgc3JjVmFsdWVdXG4gIC5ldmVyeShBcnJheS5pc0FycmF5KSA/IG9ialZhbHVlLmNvbmNhdChzcmNWYWx1ZSkgOiB1bmRlZmluZWQpO1xuXG5jb25zdCBsb2FkUmVjdXJzaXZlID0gKGRpciwgcmVsRGlyLCBkYXRhLCB2YXJzKSA9PiB7XG4gIGxldCByZXN1bHQgPSBkYXRhO1xuICBpZiAodHlwZW9mIHJlc3VsdCA9PT0gJ3N0cmluZycgfHwgcmVzdWx0IGluc3RhbmNlb2YgU3RyaW5nKSB7XG4gICAgLy8gcmVwbGFjZSB5YW1sIHZhcmlhYmxlcyB3aXRoIGRlZmF1bHRzXG4gICAgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoXG4gICAgICAvXFwke29wdDooW2EtekEtWjAtOV0rPykoPzosIFtcIiddKFthLXpBLVowLTlcXC0uXSs/KVtcIiddKT99L2csXG4gICAgICAobWF0Y2gsIGssIHYpID0+IGdldCh2YXJzLCBrLCB2IHx8IG1hdGNoKVxuICAgICk7XG4gICAgLy8gbG9hZCByZXF1aXJlc1xuICAgIGNvbnN0IG1hdGNoID0gKFxuICAgICAgL15cXCR7KHJlcXVpcmV8ZmlsZXxmaWxlRm4pXFwoKFt+Xl0/W2EtekEtWlxcZC5fXFwtQC9dKz8pXFwpKD86OihbYS16QS1aXFxkLl0rPykpPyg/OiwgKFthLXpBLVpcXGQ9XFwtJi8uOltcXF0sXSs/KSk/fSQvZ1xuICAgICkuZXhlYyhyZXN1bHQpO1xuICAgIGlmIChtYXRjaCkge1xuICAgICAgY29uc3QgdmFyc05ldyA9IHtcbiAgICAgICAgLi4udmFycyxcbiAgICAgICAgLi4uKG1hdGNoWzRdID8gSlNPTlxuICAgICAgICAgIC5wYXJzZShge1wiJHttYXRjaFs0XS5yZXBsYWNlKC8mL2csICdcIixcIicpLnJlcGxhY2UoLz0vZywgJ1wiOlwiJyl9XCJ9YCkgOiB7fSlcbiAgICAgIH07XG5cbiAgICAgIGxldCBsb2FkZWQ7XG4gICAgICBsZXQgbmV3UmVsRGlyID0gcmVsRGlyO1xuICAgICAgaWYgKFsnZmlsZScsICdmaWxlRm4nXS5pbmNsdWRlcyhtYXRjaFsxXSkpIHtcbiAgICAgICAgY29uc3QgZmlsZVBhdGggPSBtYXRjaFsyXS5zdGFydHNXaXRoKCdeJylcbiAgICAgICAgICA/IHBhdGguam9pbihyZWxEaXIsIG1hdGNoWzJdLnN1YnN0cmluZygxKSlcbiAgICAgICAgICA6IHBhdGguam9pbihkaXIsIG1hdGNoWzJdKTtcbiAgICAgICAgbmV3UmVsRGlyID0gcGF0aC5kaXJuYW1lKGZpbGVQYXRoKTtcbiAgICAgICAgbG9hZGVkID0gKGZpbGVQYXRoLmVuZHNXaXRoKCcueW1sJykgfHwgZmlsZVBhdGguZW5kc1dpdGgoJy55YW1sJykpXG4gICAgICAgICAgPyB5YW1sLnNhZmVMb2FkKGZzLnJlYWRGaWxlU3luYyhmaWxlUGF0aCwgJ3V0ZjgnKSlcbiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZ2xvYmFsLXJlcXVpcmUsIGltcG9ydC9uby1keW5hbWljLXJlcXVpcmVcbiAgICAgICAgICA6IHJlcXVpcmUoZmlsZVBhdGgpO1xuICAgICAgICBpZiAobWF0Y2hbMV0gPT09ICdmaWxlRm4nKSB7XG4gICAgICAgICAgbG9hZGVkID0gbG9hZGVkKHZhcnNOZXcpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZ2xvYmFsLXJlcXVpcmUsIGltcG9ydC9uby1keW5hbWljLXJlcXVpcmVcbiAgICAgICAgbG9hZGVkID0gcmVxdWlyZShtYXRjaFsyXSk7XG4gICAgICB9XG4gICAgICBjb25zdCB0YXJnZXQgPSBtYXRjaFszXSA/IGdldChsb2FkZWQsIG1hdGNoWzNdKSA6IGxvYWRlZDtcbiAgICAgIHJlc3VsdCA9IGxvYWRSZWN1cnNpdmUoZGlyLCBuZXdSZWxEaXIsIHR5cGVvZiB0YXJnZXQgPT09ICdmdW5jdGlvbicgPyB0YXJnZXQoKSA6IHRhcmdldCwgdmFyc05ldyk7XG4gICAgfVxuICB9XG4gIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBPYmplY3QpIHtcbiAgICBjb25zdCB0b01lcmdlID0gZ2V0KHJlc3VsdCwgJzw8PCcsIFtdKS5tYXAoKGUpID0+IGxvYWRSZWN1cnNpdmUoZGlyLCByZWxEaXIsIGUsIHZhcnMpKTtcbiAgICBkZWxldGUgcmVzdWx0Wyc8PDwnXTtcbiAgICBPYmplY3Qua2V5cyhyZXN1bHQpLmZvckVhY2goKGtleSkgPT4gc2V0KHJlc3VsdCwga2V5LCBsb2FkUmVjdXJzaXZlKGRpciwgcmVsRGlyLCBnZXQocmVzdWx0LCBrZXkpLCB2YXJzKSkpO1xuICAgIHJlc3VsdCA9IHRvTWVyZ2UucmVkdWNlKChwcmV2LCBjdXIpID0+IG1lcmdlV2l0aChwcmV2LCBjdXIsIGNvbmNhdEFycmF5cyksIHJlc3VsdCk7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbm1vZHVsZS5leHBvcnRzLmxvYWQgPSAoZmlsZVBhdGgsIHZhcnMgPSB7fSkgPT4gbG9hZFJlY3Vyc2l2ZShcbiAgcGF0aC5kaXJuYW1lKGZpbGVQYXRoKSxcbiAgcGF0aC5kaXJuYW1lKGZpbGVQYXRoKSxcbiAgeWFtbC5zYWZlTG9hZChmcy5yZWFkRmlsZVN5bmMoZmlsZVBhdGgsICd1dGY4JykpLFxuICB2YXJzXG4pO1xuXG5tb2R1bGUuZXhwb3J0cy5kdW1wID0geWFtbC5zYWZlRHVtcDtcbiJdfQ==