function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const assert = require('assert');

const path = require('path');

const fs = require('smart-fs');

const Joi = require('joi-strict');

const nock = require('nock');

const nockListener = require('./request-recorder/nock-listener');

const nockBack = nock.back;

const buildKey = interceptor => `${interceptor.method} ${interceptor.basePath}${interceptor.uri}`;

module.exports = opts => {
  Joi.assert(opts, Joi.object().keys({
    cassetteFolder: Joi.string(),
    stripHeaders: Joi.boolean(),
    strict: Joi.boolean(),
    heal: Joi.alternatives(Joi.boolean(), Joi.string())
  }), 'Invalid Options Provided');
  let nockDone = null;
  let cassetteFilePath = null;
  const knownCassetteNames = [];
  const records = [];
  const outOfOrderErrors = [];
  const expectedCassette = [];
  const pendingMocks = [];
  return {
    inject: async cassetteFile => {
      assert(nockDone === null);
      knownCassetteNames.push(cassetteFile);
      records.length = 0;
      outOfOrderErrors.length = 0;
      expectedCassette.length = 0;
      pendingMocks.length = 0;
      cassetteFilePath = path.join(opts.cassetteFolder, cassetteFile);
      const hasCassette = fs.existsSync(cassetteFilePath);

      if (hasCassette) {
        const cassetteContent = fs.smartRead(cassetteFilePath);
        pendingMocks.push(...nock.define(cassetteContent).map((e, idx) => ({
          idx,
          key: buildKey(e.interceptors[0]),
          record: cassetteContent[idx]
        })));
      }

      nockBack.setMode(hasCassette ? 'lockdown' : 'record');
      nockBack.fixtures = opts.cassetteFolder;
      nockListener.subscribe('no match', (_, req, body) => {
        assert(hasCassette === true);
      });
      nockDone = await new Promise(resolve => nockBack(cassetteFile, {
        before: (scope, scopeIdx) => {
          records.push(_objectSpread({}, scope)); // eslint-disable-next-line no-param-reassign

          scope.filteringRequestBody = body => {
            if (opts.heal === 'body') {
              const idx = pendingMocks.findIndex(m => m.idx === scopeIdx);
              assert(idx === 0);
              let requestBody = body;

              try {
                requestBody = JSON.parse(requestBody);
              } catch (e) {
                /* */
              }

              pendingMocks[idx].record.body = requestBody === null ? 'null' : requestBody;
              return scope.body;
            }

            return body;
          };

          return scope;
        },
        after: (scope, scopeIdx) => {
          scope.on('request', () => {
            const idx = pendingMocks.findIndex(e => e.idx === scopeIdx);
            expectedCassette.push(pendingMocks[idx].record);

            if (idx !== 0) {
              outOfOrderErrors.push(pendingMocks[idx].key);
            }

            pendingMocks.splice(idx, 1);
          });
        },
        afterRecord: recordings => JSON.stringify(opts.stripHeaders === true ? recordings.map(r => {
          const res = _objectSpread({}, r);

          delete res.rawHeaders;
          return res;
        }) : recordings, null, 2)
      }, resolve));
    },
    release: () => {
      assert(nockDone !== null);
      nockDone();
      nockDone = null;
      nockListener.unsubscribeAll('no match');

      if (opts.heal !== false) {
        fs.smartWrite(cassetteFilePath, expectedCassette);
      }

      if (opts.strict !== false) {
        if (outOfOrderErrors.length !== 0) {
          throw new Error(`Out of Order Recordings: ${outOfOrderErrors.join(', ')}`);
        }

        if (pendingMocks.length !== 0) {
          throw new Error(`Unmatched Recordings: ${pendingMocks.map(e => e.key).join(', ')}`);
        }
      }
    },
    shutdown: () => {
      const unexpectedFiles = fs.walkDir(opts.cassetteFolder).filter(f => !knownCassetteNames.includes(f));

      if (unexpectedFiles.length !== 0) {
        throw new Error(`Unexpected file(s) in cassette folder: ${unexpectedFiles.join(', ')}`);
      }
    },
    get: () => ({
      records: records.slice(),
      outOfOrderErrors: outOfOrderErrors.slice(),
      unmatchedRecordings: pendingMocks.map(e => e.key).slice(),
      expectedCassette: expectedCassette.slice(),
      cassetteFilePath
    })
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb2R1bGVzL3JlcXVlc3QtcmVjb3JkZXIuanMiXSwibmFtZXMiOlsiYXNzZXJ0IiwicmVxdWlyZSIsInBhdGgiLCJmcyIsIkpvaSIsIm5vY2siLCJub2NrTGlzdGVuZXIiLCJub2NrQmFjayIsImJhY2siLCJidWlsZEtleSIsImludGVyY2VwdG9yIiwibWV0aG9kIiwiYmFzZVBhdGgiLCJ1cmkiLCJtb2R1bGUiLCJleHBvcnRzIiwib3B0cyIsIm9iamVjdCIsImtleXMiLCJjYXNzZXR0ZUZvbGRlciIsInN0cmluZyIsInN0cmlwSGVhZGVycyIsImJvb2xlYW4iLCJzdHJpY3QiLCJoZWFsIiwiYWx0ZXJuYXRpdmVzIiwibm9ja0RvbmUiLCJjYXNzZXR0ZUZpbGVQYXRoIiwia25vd25DYXNzZXR0ZU5hbWVzIiwicmVjb3JkcyIsIm91dE9mT3JkZXJFcnJvcnMiLCJleHBlY3RlZENhc3NldHRlIiwicGVuZGluZ01vY2tzIiwiaW5qZWN0IiwiY2Fzc2V0dGVGaWxlIiwicHVzaCIsImxlbmd0aCIsImpvaW4iLCJoYXNDYXNzZXR0ZSIsImV4aXN0c1N5bmMiLCJjYXNzZXR0ZUNvbnRlbnQiLCJzbWFydFJlYWQiLCJkZWZpbmUiLCJtYXAiLCJlIiwiaWR4Iiwia2V5IiwiaW50ZXJjZXB0b3JzIiwicmVjb3JkIiwic2V0TW9kZSIsImZpeHR1cmVzIiwic3Vic2NyaWJlIiwiXyIsInJlcSIsImJvZHkiLCJQcm9taXNlIiwicmVzb2x2ZSIsImJlZm9yZSIsInNjb3BlIiwic2NvcGVJZHgiLCJmaWx0ZXJpbmdSZXF1ZXN0Qm9keSIsImZpbmRJbmRleCIsIm0iLCJyZXF1ZXN0Qm9keSIsIkpTT04iLCJwYXJzZSIsImFmdGVyIiwib24iLCJzcGxpY2UiLCJhZnRlclJlY29yZCIsInJlY29yZGluZ3MiLCJzdHJpbmdpZnkiLCJyIiwicmVzIiwicmF3SGVhZGVycyIsInJlbGVhc2UiLCJ1bnN1YnNjcmliZUFsbCIsInNtYXJ0V3JpdGUiLCJFcnJvciIsInNodXRkb3duIiwidW5leHBlY3RlZEZpbGVzIiwid2Fsa0RpciIsImZpbHRlciIsImYiLCJpbmNsdWRlcyIsImdldCIsInNsaWNlIiwidW5tYXRjaGVkUmVjb3JkaW5ncyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsTUFBTUEsTUFBTSxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUF0Qjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1FLEVBQUUsR0FBR0YsT0FBTyxDQUFDLFVBQUQsQ0FBbEI7O0FBQ0EsTUFBTUcsR0FBRyxHQUFHSCxPQUFPLENBQUMsWUFBRCxDQUFuQjs7QUFDQSxNQUFNSSxJQUFJLEdBQUdKLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1LLFlBQVksR0FBR0wsT0FBTyxDQUFDLGtDQUFELENBQTVCOztBQUVBLE1BQU1NLFFBQVEsR0FBR0YsSUFBSSxDQUFDRyxJQUF0Qjs7QUFFQSxNQUFNQyxRQUFRLEdBQUlDLFdBQUQsSUFBa0IsR0FBRUEsV0FBVyxDQUFDQyxNQUFPLElBQUdELFdBQVcsQ0FBQ0UsUUFBUyxHQUFFRixXQUFXLENBQUNHLEdBQUksRUFBbEc7O0FBRUFDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFrQkMsSUFBRCxJQUFVO0FBQ3pCWixFQUFBQSxHQUFHLENBQUNKLE1BQUosQ0FBV2dCLElBQVgsRUFBaUJaLEdBQUcsQ0FBQ2EsTUFBSixHQUFhQyxJQUFiLENBQWtCO0FBQ2pDQyxJQUFBQSxjQUFjLEVBQUVmLEdBQUcsQ0FBQ2dCLE1BQUosRUFEaUI7QUFFakNDLElBQUFBLFlBQVksRUFBRWpCLEdBQUcsQ0FBQ2tCLE9BQUosRUFGbUI7QUFHakNDLElBQUFBLE1BQU0sRUFBRW5CLEdBQUcsQ0FBQ2tCLE9BQUosRUFIeUI7QUFJakNFLElBQUFBLElBQUksRUFBRXBCLEdBQUcsQ0FBQ3FCLFlBQUosQ0FBaUJyQixHQUFHLENBQUNrQixPQUFKLEVBQWpCLEVBQWdDbEIsR0FBRyxDQUFDZ0IsTUFBSixFQUFoQztBQUoyQixH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LGtCQUFrQixDQUFDd0QsUUFBbkIsQ0FBNEJELENBQTVCLENBQS9DLENBQXhCOztBQUNBLFVBQUlILGVBQWUsQ0FBQzVDLE1BQWhCLEtBQTJCLENBQS9CLEVBQWtDO0FBQ2hDLGNBQU0sSUFBSTBDLEtBQUosQ0FBVywwQ0FBeUNFLGVBQWUsQ0FBQzNDLElBQWhCLENBQXFCLElBQXJCLENBQTJCLEVBQS9FLENBQU47QUFDRDtBQUNGLEtBeEZLO0FBeUZOZ0QsSUFBQUEsR0FBRyxFQUFFLE9BQU87QUFDVnhELE1BQUFBLE9BQU8sRUFBRUEsT0FBTyxDQUFDeUQsS0FBUixFQURDO0FBRVZ4RCxNQUFBQSxnQkFBZ0IsRUFBRUEsZ0JBQWdCLENBQUN3RCxLQUFqQixFQUZSO0FBR1ZDLE1BQUFBLG1CQUFtQixFQUFFdkQsWUFBWSxDQUFDVyxHQUFiLENBQWtCQyxDQUFELElBQU9BLENBQUMsQ0FBQ0UsR0FBMUIsRUFBK0J3QyxLQUEvQixFQUhYO0FBSVZ2RCxNQUFBQSxnQkFBZ0IsRUFBRUEsZ0JBQWdCLENBQUN1RCxLQUFqQixFQUpSO0FBS1YzRCxNQUFBQTtBQUxVLEtBQVA7QUF6RkMsR0FBUjtBQWlHRCxDQWhIRCIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGFzc2VydCA9IHJlcXVpcmUoJ2Fzc2VydCcpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IGZzID0gcmVxdWlyZSgnc21hcnQtZnMnKTtcbmNvbnN0IEpvaSA9IHJlcXVpcmUoJ2pvaS1zdHJpY3QnKTtcbmNvbnN0IG5vY2sgPSByZXF1aXJlKCdub2NrJyk7XG5jb25zdCBub2NrTGlzdGVuZXIgPSByZXF1aXJlKCcuL3JlcXVlc3QtcmVjb3JkZXIvbm9jay1saXN0ZW5lcicpO1xuXG5jb25zdCBub2NrQmFjayA9IG5vY2suYmFjaztcblxuY29uc3QgYnVpbGRLZXkgPSAoaW50ZXJjZXB0b3IpID0+IGAke2ludGVyY2VwdG9yLm1ldGhvZH0gJHtpbnRlcmNlcHRvci5iYXNlUGF0aH0ke2ludGVyY2VwdG9yLnVyaX1gO1xuXG5tb2R1bGUuZXhwb3J0cyA9IChvcHRzKSA9PiB7XG4gIEpvaS5hc3NlcnQob3B0cywgSm9pLm9iamVjdCgpLmtleXMoe1xuICAgIGNhc3NldHRlRm9sZGVyOiBKb2kuc3RyaW5nKCksXG4gICAgc3RyaXBIZWFkZXJzOiBKb2kuYm9vbGVhbigpLFxuICAgIHN0cmljdDogSm9pLmJvb2xlYW4oKSxcbiAgICBoZWFsOiBKb2kuYWx0ZXJuYXRpdmVzKEpvaS5ib29sZWFuKCksIEpvaS5zdHJpbmcoKSlcbiAgfSksICdJbnZhbGlkIE9wdGlvbnMgUHJvdmlkZWQnKTtcbiAgbGV0IG5vY2tEb25lID0gbnVsbDtcbiAgbGV0IGNhc3NldHRlRmlsZVBhdGggPSBudWxsO1xuICBjb25zdCBrbm93bkNhc3NldHRlTmFtZXMgPSBbXTtcbiAgY29uc3QgcmVjb3JkcyA9IFtdO1xuICBjb25zdCBvdXRPZk9yZGVyRXJyb3JzID0gW107XG4gIGNvbnN0IGV4cGVjdGVkQ2Fzc2V0dGUgPSBbXTtcbiAgY29uc3QgcGVuZGluZ01vY2tzID0gW107XG5cbiAgcmV0dXJuICh7XG4gICAgaW5qZWN0OiBhc3luYyAoY2Fzc2V0dGVGaWxlKSA9PiB7XG4gICAgICBhc3NlcnQobm9ja0RvbmUgPT09IG51bGwpO1xuICAgICAga25vd25DYXNzZXR0ZU5hbWVzLnB1c2goY2Fzc2V0dGVGaWxlKTtcbiAgICAgIHJlY29yZHMubGVuZ3RoID0gMDtcbiAgICAgIG91dE9mT3JkZXJFcnJvcnMubGVuZ3RoID0gMDtcbiAgICAgIGV4cGVjdGVkQ2Fzc2V0dGUubGVuZ3RoID0gMDtcbiAgICAgIHBlbmRpbmdNb2Nrcy5sZW5ndGggPSAwO1xuXG4gICAgICBjYXNzZXR0ZUZpbGVQYXRoID0gcGF0aC5qb2luKG9wdHMuY2Fzc2V0dGVGb2xkZXIsIGNhc3NldHRlRmlsZSk7XG4gICAgICBjb25zdCBoYXNDYXNzZXR0ZSA9IGZzLmV4aXN0c1N5bmMoY2Fzc2V0dGVGaWxlUGF0aCk7XG4gICAgICBpZiAoaGFzQ2Fzc2V0dGUpIHtcbiAgICAgICAgY29uc3QgY2Fzc2V0dGVDb250ZW50ID0gZnMuc21hcnRSZWFkKGNhc3NldHRlRmlsZVBhdGgpO1xuICAgICAgICBwZW5kaW5nTW9ja3MucHVzaCguLi5ub2NrXG4gICAgICAgICAgLmRlZmluZShjYXNzZXR0ZUNvbnRlbnQpXG4gICAgICAgICAgLm1hcCgoZSwgaWR4KSA9PiAoe1xuICAgICAgICAgICAgaWR4LFxuICAgICAgICAgICAga2V5OiBidWlsZEtleShlLmludGVyY2VwdG9yc1swXSksXG4gICAgICAgICAgICByZWNvcmQ6IGNhc3NldHRlQ29udGVudFtpZHhdXG4gICAgICAgICAgfSkpKTtcbiAgICAgIH1cblxuICAgICAgbm9ja0JhY2suc2V0TW9kZShoYXNDYXNzZXR0ZSA/ICdsb2NrZG93bicgOiAncmVjb3JkJyk7XG4gICAgICBub2NrQmFjay5maXh0dXJlcyA9IG9wdHMuY2Fzc2V0dGVGb2xkZXI7XG4gICAgICBub2NrTGlzdGVuZXIuc3Vic2NyaWJlKCdubyBtYXRjaCcsIChfLCByZXEsIGJvZHkpID0+IHtcbiAgICAgICAgYXNzZXJ0KGhhc0Nhc3NldHRlID09PSB0cnVlKTtcbiAgICAgIH0pO1xuICAgICAgbm9ja0RvbmUgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gbm9ja0JhY2soY2Fzc2V0dGVGaWxlLCB7XG4gICAgICAgIGJlZm9yZTogKHNjb3BlLCBzY29wZUlkeCkgPT4ge1xuICAgICAgICAgIHJlY29yZHMucHVzaCh7IC4uLnNjb3BlIH0pO1xuICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wYXJhbS1yZWFzc2lnblxuICAgICAgICAgIHNjb3BlLmZpbHRlcmluZ1JlcXVlc3RCb2R5ID0gKGJvZHkpID0+IHtcbiAgICAgICAgICAgIGlmIChvcHRzLmhlYWwgPT09ICdib2R5Jykge1xuICAgICAgICAgICAgICBjb25zdCBpZHggPSBwZW5kaW5nTW9ja3MuZmluZEluZGV4KChtKSA9PiBtLmlkeCA9PT0gc2NvcGVJZHgpO1xuICAgICAgICAgICAgICBhc3NlcnQoaWR4ID09PSAwKTtcbiAgICAgICAgICAgICAgbGV0IHJlcXVlc3RCb2R5ID0gYm9keTtcbiAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0Qm9keSA9IEpTT04ucGFyc2UocmVxdWVzdEJvZHkpO1xuICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgLyogKi9cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBwZW5kaW5nTW9ja3NbaWR4XS5yZWNvcmQuYm9keSA9IHJlcXVlc3RCb2R5ID09PSBudWxsID8gJ251bGwnIDogcmVxdWVzdEJvZHk7XG4gICAgICAgICAgICAgIHJldHVybiBzY29wZS5ib2R5O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGJvZHk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICByZXR1cm4gc2NvcGU7XG4gICAgICAgIH0sXG4gICAgICAgIGFmdGVyOiAoc2NvcGUsIHNjb3BlSWR4KSA9PiB7XG4gICAgICAgICAgc2NvcGUub24oJ3JlcXVlc3QnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpZHggPSBwZW5kaW5nTW9ja3MuZmluZEluZGV4KChlKSA9PiBlLmlkeCA9PT0gc2NvcGVJZHgpO1xuICAgICAgICAgICAgZXhwZWN0ZWRDYXNzZXR0ZS5wdXNoKHBlbmRpbmdNb2Nrc1tpZHhdLnJlY29yZCk7XG4gICAgICAgICAgICBpZiAoaWR4ICE9PSAwKSB7XG4gICAgICAgICAgICAgIG91dE9mT3JkZXJFcnJvcnMucHVzaChwZW5kaW5nTW9ja3NbaWR4XS5rZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGVuZGluZ01vY2tzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9LFxuICAgICAgICBhZnRlclJlY29yZDogKHJlY29yZGluZ3MpID0+IEpTT05cbiAgICAgICAgICAuc3RyaW5naWZ5KG9wdHMuc3RyaXBIZWFkZXJzID09PSB0cnVlID8gcmVjb3JkaW5ncy5tYXAoKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlcyA9IHsgLi4uciB9O1xuICAgICAgICAgICAgZGVsZXRlIHJlcy5yYXdIZWFkZXJzO1xuICAgICAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgICAgICB9KSA6IHJlY29yZGluZ3MsIG51bGwsIDIpXG4gICAgICB9LCByZXNvbHZlKSk7XG4gICAgfSxcbiAgICByZWxlYXNlOiAoKSA9PiB7XG4gICAgICBhc3NlcnQobm9ja0RvbmUgIT09IG51bGwpO1xuICAgICAgbm9ja0RvbmUoKTtcbiAgICAgIG5vY2tEb25lID0gbnVsbDtcbiAgICAgIG5vY2tMaXN0ZW5lci51bnN1YnNjcmliZUFsbCgnbm8gbWF0Y2gnKTtcbiAgICAgIGlmIChvcHRzLmhlYWwgIT09IGZhbHNlKSB7XG4gICAgICAgIGZzLnNtYXJ0V3JpdGUoY2Fzc2V0dGVGaWxlUGF0aCwgZXhwZWN0ZWRDYXNzZXR0ZSk7XG4gICAgICB9XG4gICAgICBpZiAob3B0cy5zdHJpY3QgIT09IGZhbHNlKSB7XG4gICAgICAgIGlmIChvdXRPZk9yZGVyRXJyb3JzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgT3V0IG9mIE9yZGVyIFJlY29yZGluZ3M6ICR7b3V0T2ZPcmRlckVycm9ycy5qb2luKCcsICcpfWApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwZW5kaW5nTW9ja3MubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbm1hdGNoZWQgUmVjb3JkaW5nczogJHtwZW5kaW5nTW9ja3MubWFwKChlKSA9PiBlLmtleSkuam9pbignLCAnKX1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG4gICAgc2h1dGRvd246ICgpID0+IHtcbiAgICAgIGNvbnN0IHVuZXhwZWN0ZWRGaWxlcyA9IGZzLndhbGtEaXIob3B0cy5jYXNzZXR0ZUZvbGRlcikuZmlsdGVyKChmKSA9PiAha25vd25DYXNzZXR0ZU5hbWVzLmluY2x1ZGVzKGYpKTtcbiAgICAgIGlmICh1bmV4cGVjdGVkRmlsZXMubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBmaWxlKHMpIGluIGNhc3NldHRlIGZvbGRlcjogJHt1bmV4cGVjdGVkRmlsZXMuam9pbignLCAnKX1gKTtcbiAgICAgIH1cbiAgICB9LFxuICAgIGdldDogKCkgPT4gKHtcbiAgICAgIHJlY29yZHM6IHJlY29yZHMuc2xpY2UoKSxcbiAgICAgIG91dE9mT3JkZXJFcnJvcnM6IG91dE9mT3JkZXJFcnJvcnMuc2xpY2UoKSxcbiAgICAgIHVubWF0Y2hlZFJlY29yZGluZ3M6IHBlbmRpbmdNb2Nrcy5tYXAoKGUpID0+IGUua2V5KS5zbGljZSgpLFxuICAgICAgZXhwZWN0ZWRDYXNzZXR0ZTogZXhwZWN0ZWRDYXNzZXR0ZS5zbGljZSgpLFxuICAgICAgY2Fzc2V0dGVGaWxlUGF0aFxuICAgIH0pXG4gIH0pO1xufTtcbiJdfQ==